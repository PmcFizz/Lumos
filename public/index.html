<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LUMOS</title>
  <link rel="icon" href="lumos.png" />
  <!-- 引入 Bootstrap CSS -->
  <link rel="stylesheet" href="./bootstrap.min.css">
  <link rel="stylesheet" href="./index.css">
</head>

<body>
  <div class="container">
    <div class="row h-full">
      <div class="col-3 h-full">
        <h4>Configure Device</h4>
        <form id="modbusForm">
          <div class="form-group mb-2">
            <label for="deviceName" class="col-form-label-sm mb-0">Device Name:</label>
            <input type="text" class="form-control form-control-sm" value="fizz" id="deviceName" required>
          </div>
          <div class="form-group mb-2">
            <label for="serialPort" class="col-form-label-sm mb-0">Serial Port:</label>
            <input type="text" class="form-control form-control-sm" id="serialPort" required>
          </div>
          <div class="form-group mb-2">
            <label for="modbusId" class="col-form-label-sm mb-0">Modbus ID:</label>
            <input type="number" class="form-control form-control-sm" type="number" value="1" id="modbusId" required>
          </div>
          <div class="form-group mb-2">
            <label for="period" class="col-form-label-sm mb-0">Period(s):</label>
            <input type="number" class="form-control form-control-sm" type="number" value="6" id="period" required>
          </div>
          <p class="mb-1">
            <button type="submit" class="btn btn-primary btn-sm mb-1">Connection</button>
            <button type="button" id="query-btn" class="btn btn-sm btn-primary mb-1">Auto Query Status</button>
          </p>
          <p class="mb-1">
            <button type="button" id="all-on-btn" class="btn btn-sm btn-primary">All On</button>
            <button type="button" id="all-off-btn" class="btn btn-sm btn-primary">All Off</button>
          </p>
          <p class="mb-1">
            <button type="button" id="start-loop-btn" class="btn btn-sm btn-primary">Start Loop</button>
            <button type="button" id="stop-loop-btn" class="btn btn-sm btn-primary">Stop Loop</button>
          </p>
          <p class="mb-1">
            <button type="button" id="set-brightness-btn" class="btn btn-sm btn-primary">Set Brightness</button>
            <button type="button" id="set-color-btn" class="btn btn-sm btn-primary">Set Color</button>
          </p>
        </form>

      </div>
      <div class="col-9 px-4 border-left">

        <h4>Base Info</h4>
        <div class="row pb-4 border-bottom">
          <div class="col-3">ID: <span id="config_modbusId">——</span></div>
          <div class="col-3">Baud Rate : <span id="config_baudRate">——</span></div>
          <div class="col-3">Work Mode: <span id="config_workMode">——</span></div>
          <div class="col-3">Brightness: <span id="config_brightness">——</span></div>
          <div class="col-3">Effective Bit: <span id="config_effectiveBit">——</span></div>
          <div class="col-3">Output Circuits: <span id="config_outputCircuits">——</span></div>
        </div>
        <div class="row pt-2" id="led-container">
        </div>

      </div>
    </div>

  </div>

  <script>
    let interval = null
    let brightnessValue = 10
    let isAutoQueryStatus = true
    const allOnBtn = document.querySelector("#all-on-btn")
    const allOffBtn = document.querySelector("#all-off-btn")
    const startLoopBtn = document.querySelector("#start-loop-btn")
    const stopLoopBtn = document.querySelector("#stop-loop-btn")
    const queryBtn = document.querySelector("#query-btn")
    const setBrightnessBtn = document.querySelector("#set-brightness-btn")
    const setColorBtn = document.querySelector("#set-color-btn")


    allOnBtn.addEventListener('click', setAllOn)
    allOffBtn.addEventListener('click', setAllOff)
    startLoopBtn.addEventListener('click', startLoop)
    stopLoopBtn.addEventListener('click', stopLoop)
    queryBtn.addEventListener('click', queryLedStatus)
    setBrightnessBtn.addEventListener('click', setBrightness)
    setColorBtn.addEventListener('click', setColor)

    document.getElementById('modbusForm').addEventListener('submit', async function (e) {
      if (interval) {
        clearInterval(interval)
      }
      e.preventDefault();
      const deviceName = document.querySelector('#deviceName').value;
      const serialPort = document.querySelector('#serialPort').value;
      const modbusId = document.querySelector('#modbusId').value;
      const period = document.querySelector('#period').value;
      const data = await sendData('/configure-modbus', { serialPort, modbusId, deviceName })

      if (data.success) {
        const indexDomMap = {
          0: 'config_modbusId',
          1: 'config_baudRate',
          2: 'config_workMode',
          // 3: 'config_modbusId',
          // 4: 'config_modbusId',
          // 5: 'config_modbusId',
          // 6: 'config_modbusId',
          7: 'config_brightness',
          8: 'config_effectiveBit',
          9: 'config_outputCircuits',
        }
        data.data.configData[1] = data.data.configData[1] * 100
        for (const [key, value] of Object.entries(indexDomMap)) {
          document.querySelector(`#${value}`).innerText = data.data.configData[key]
        }

        if (isAutoQueryStatus) {
          interval = setInterval(() => {
            queryLedStatus()
          }, period * 1000)
        }

      } else {
        alert('Failed to read registers: ' + data.message);
      }

    });

    async function sendData(url, dataToSend) {
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dataToSend),
        });
        const result = await response.json();
        if (result.success) {
          console.log(result, 'result')
          return result;
        } else {
          alert('Failed to read registers: ' + result.message);
        }
      } catch (error) {
        console.error('Error during sendData:', error);
        throw error;  // Optionally re-throw to allow further handling upstream
      }
    }

    async function setAllOn() {
      try {
        const data = await sendData('/all-on-led', {}); // Assuming empty object if no data is needed
        if (data && data.success) {
          console.log('操作成功');
          queryLedStatus()
        }
      } catch (error) {
        console.error('Error in setAllOn:', error);
      }
    }

    async function setAllOff() {
      try {
        const data = await sendData('/all-off-led', {}); // Assuming empty object if no data is needed
        if (data && data.success) {
          console.log('操作成功');
          queryLedStatus()
        }
      } catch (error) {
        console.error('Error in setAllOn:', error);
      }
    }

    async function startLoop() {
      try {
        const data = await sendData('/start-loop-light-sign-led', {}); // Assuming empty object if no data is needed
        if (data && data.success) {
          console.log('操作成功');
        }
      } catch (error) {
        console.error('Error in setAllOn:', error);
      }

    }

    async function stopLoop() {
      try {
        const data = await sendData('/stop-loop-light-sign-led', {}); // Assuming empty object if no data is needed
        if (data && data.success) {
          console.log('操作成功');
        }
      } catch (error) {
        console.error('Error in setAllOn:', error);
      }
    }

    function setHtml(arr) {
      const lHtml = []
      arr.forEach((x, i) => {
        const { state } = x
        const styleClass = `btn ${state ? 'btn-outline-success' : 'btn-outline-secondary'}  btn-sm`
        const ledNo = i + 1
        lHtml.push(`
          <button type="button" class="${styleClass}"" onclick="toggleStatus(${ledNo}, ${!state})" >${ledNo} ${state ? 'ON' : 'OFF'}</button>
        `);
      })
      document.querySelector('#led-container').innerHTML = lHtml.join('')
    }

    async function toggleStatus(lightNumber, state) {
      try {
        const data = await sendData('/set-light', { lightNumber, state });
        if (data && data.success) {
          console.log('操作成功');
          queryLedStatus()
        }
      } catch (error) {
        console.error('Error in setAllOn:', error);
      }
    }

    async function changeQueryWay() {
      if (isAutoQueryStatus) {
        if (interval) {
          clearInterval(interval)
          queryBtn.innerText = 'Manual Query Led Status'
        }
      } else {
        interval = setInterval(() => {
          queryLedStatus()
        }, period * 1000)
        queryBtn.innerText = 'Auto Query Led Status'
      }
    }

    async function queryLedStatus() {
      const data = await sendData('/query-led-status', { deviceId: "eb7793a4-0dfa-4b2e-a6ec-94b7753dfc49" })
      if (data.success) {
        setHtml(data.data)
      }
    }

    async function setBrightness() {
      try {
        const data = await sendData('/set-led-brightness', { brightnessValue }); // Assuming empty object if no data is needed
        if (data && data.success) {
          console.log('操作成功');
          if (brightnessValue == 10) {
            brightnessValue = 255
          } else {
            brightnessValue = 10
          }
        }
      } catch (error) {
        console.error('Error in setAllOn:', error);
      }
    }

    async function setColor() {
      try {
        const data = await sendData('/set-led-color', { colorValue: '' }); // Assuming empty object if no data is needed
        if (data && data.success) {
          console.log('操作成功');
        }
      } catch (error) {
        console.error('Error in setAllOn:', error);
      }
    }

    function testMode() {
      const array = Array(100).fill(0).map(() => ({
        state: Math.random() < 0.5
      }));
      setHtml(array)

      const configData = [1, 96, 1, 255, 1, 2, 0, 255, 16, 20]
      const indexDomMap = {
        0: 'config_modbusId',
        1: 'config_baudRate',
        2: 'config_workMode',
        7: 'config_brightness',
        8: 'config_effectiveBit',
        9: 'config_outputCircuits',
      }
      configData[1] = configData[1] * 100
      for (const [key, value] of Object.entries(indexDomMap)) {
        document.querySelector(`#${value}`).innerText = configData[key]
      }

    }

    testMode()
  </script>
</body>

</html>